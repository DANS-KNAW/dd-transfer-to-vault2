<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Description - dd-transfer-to-vault</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Description";
        var mkdocs_page_input_path = "description.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> dd-transfer-to-vault
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Manual</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="..">Synopsis</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Description</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#interfaces">Interfaces</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#provided">Provided</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#inbox">Inbox</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#admin-console">Admin console</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#consumed">Consumed</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#data-vault-catalog">Data Vault Catalog</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#nbn-database">NBN Database</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#data-vault-import-inbox">Data Vault import inbox</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#processing">Processing</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#inbox_1">Inbox</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#validation">Validation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#metadata-extraction">Metadata extraction</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nbn-registration">NBN registration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#transfer-to-vault-and-layer-management">Transfer to vault and layer management</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#confirmation-of-archiving">Confirmation of archiving</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation & building</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Context</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../arch/">â‡’ DANS Data Station Architecture</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">dd-transfer-to-vault</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Manual &raquo;</li><li>Description</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/DANS-KNAW/dd-transfer-to-vault/edit/master/docs/description.md"> Edit on DANS-KNAW/dd-transfer-to-vault</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="description">DESCRIPTION<a class="headerlink" href="#description" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>This service is responsible for taking dataset version exports (DVE for short), cataloging them and transferring them to the DANS data vault. If the dataset
version export is the first version of a dataset, an <a href="https://www.kb.nl/en/about-us/services/nbn-agency-nl" target="_blank">NBN persistent identifier</a> is minted for the dataset and registered in the NBN database.
For more information about the context of this service, see the <a href="https://dans-knaw.github.io/dans-datastation-architecture/datastation/" target="_blank">Data Station architecture overview</a>.</p>
<h2 id="interfaces">Interfaces<a class="headerlink" href="#interfaces" title="Permanent link">&para;</a></h2>
<p><img alt="Interfaces" src="../img/overview.png" /></p>
<h3 id="provided">Provided<a class="headerlink" href="#provided" title="Permanent link">&para;</a></h3>
<h4 id="inbox">Inbox<a class="headerlink" href="#inbox" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: Shared filesystem</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to receive DVEs from the Data Stations and other services</li>
</ul>
<h4 id="admin-console">Admin console<a class="headerlink" href="#admin-console" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: application monitoring and management</li>
</ul>
<h3 id="consumed">Consumed<a class="headerlink" href="#consumed" title="Permanent link">&para;</a></h3>
<h4 id="data-vault-catalog">Data Vault Catalog<a class="headerlink" href="#data-vault-catalog" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to maintain information about the datasets and their versions that are stored in the DANS data vault</li>
</ul>
<h4 id="nbn-database">NBN Database<a class="headerlink" href="#nbn-database" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>external</strong></li>
<li><em>Purpose</em>: to mint and register NBN persistent identifiers for datasets</li>
</ul>
<h4 id="data-vault-import-inbox">Data Vault import inbox<a class="headerlink" href="#data-vault-import-inbox" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: Shared filesystem</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to import DVEs into the DANS data vault</li>
</ul>
<h6 id="data-vault-api">Data Vault API<a class="headerlink" href="#data-vault-api" title="Permanent link">&para;</a></h6>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to issue commands to the DANS data vault and retrieve information from it</li>
</ul>
<h2 id="processing">Processing<a class="headerlink" href="#processing" title="Permanent link">&para;</a></h2>
<p>This service is best viewed as a processing pipeline for DVEs. It connects a source that produces DVEs to a target DANS
<a href="https://dans-knaw.github.io/dans-datastation-architecture/data-vault-storage-root/" target="_blank">Data Vault Storage Root</a>, which stores the DVEs as OCFL object versions. A source can be a Data Station or a Vault as a Service client. The
service takes care of cataloging the DVEs and ensuring that the dataset is resolvable via the NBN persistent identifier. It attempts to do this in an efficient
way, by processing multiple DVEs in parallel, while ensuring that the order of the dataset version exports is preserved. Furthermore, the service will attempt
to resume processing of DVEs that were left unfinished in the event of a crash or restart.</p>
<h3 id="inbox_1">Inbox<a class="headerlink" href="#inbox_1" title="Permanent link">&para;</a></h3>
<p>The inbox is a directory into which DVEs are dropped. When a DVE is detected the inbox will determine what the NBN of the target dataset is. DVEs for the same
dataset version are processed in order, but DVEs for different dataset versions can be processed in parallel, except for the transfer to the vault (see below).</p>
<h3 id="validation">Validation<a class="headerlink" href="#validation" title="Permanent link">&para;</a></h3>
<p>The first step in the processing pipeline is to validate the DVE. Currently, the only layout that is supported is the [bagpack] layout. If the DVE is not a
bagpack, it will be rejected. Any other DVEs for the same dataset version will be blocked from processing until the problem is resolved.</p>
<h3 id="metadata-extraction">Metadata extraction<a class="headerlink" href="#metadata-extraction" title="Permanent link">&para;</a></h3>
<p>The next step is to extract the metadata from the DVE and to create or update the dataset version in the DANS data vault catalog. The main source of metadata is
the <code>metadata/oai-ore.jsonld</code> file in the DVE.</p>
<h3 id="nbn-registration">NBN registration<a class="headerlink" href="#nbn-registration" title="Permanent link">&para;</a></h3>
<p>After the Vault Catalog has been updated, the NBN persistent identifier is minted and scheduled for registration in the NBN database. This is done in a separate
background thread which uses a database table as a queue, so that the registration can be retried in case of a restart or crash.</p>
<h3 id="transfer-to-vault-and-layer-management">Transfer to vault and layer management<a class="headerlink" href="#transfer-to-vault-and-layer-management" title="Permanent link">&para;</a></h3>
<p>Finally, the DVE is extracted to the current DANS data vault import inbox batch for this instance of <code>dd-transfer-to-vault</code>. If the size of the batch exceeds a
configured threshold, the service will do two things:</p>
<ol>
<li>Check if a new layer is needed. If so, it will issue a command to the DANS data vault to create a new layer.</li>
<li>Issue a command to the DANS data vault to import the current batch of DVEs.</li>
</ol>
<p>This step is executed on a single dedicated thread, so that determining the size of the batch can be done reliably. The import command will return a tracking
URL which can be used to monitor the progress of the import. A confirmation of archiving task is scheduled to check the status of the import and to confirm that
the DVE has been archived in the DANS data vault.</p>
<h3 id="confirmation-of-archiving">Confirmation of archiving<a class="headerlink" href="#confirmation-of-archiving" title="Permanent link">&para;</a></h3>
<p>This step is also performed in a separate background thread, similar to the NBN registration. When <code>dd-data-vault</code> confirms that the DVE has been archived, the
Vault Catalog is updated to mark the dataset version as archived.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Synopsis"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../installation/" class="btn btn-neutral float-right" title="Installation & building">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../installation/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
